<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Learning Journal</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü§ñ</text></svg>">
    <!-- PDF.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <!-- MathJax for LaTeX equations -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <!-- Prism.js for syntax highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-dark.min.css" rel="stylesheet" media="(prefers-color-scheme: dark)" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
            }
        };
    </script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            --primary-color: #2563eb;
            --secondary-color: #1e40af;
            --accent-color: #3b82f6;
            --background-color: #ffffff;
            --surface-color: #f8fafc;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }

        [data-theme="dark"] {
            --primary-color: #3b82f6;
            --secondary-color: #2563eb;
            --accent-color: #60a5fa;
            --background-color: #0f172a;
            --surface-color: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border-color: #334155;
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.3), 0 1px 2px -1px rgb(0 0 0 / 0.3);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.3), 0 4px 6px -4px rgb(0 0 0 / 0.3);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: var(--background-color);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        /* Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background-color: var(--surface-color);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 1000;
            box-shadow: var(--shadow);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
            text-decoration: none;
        }

        .search-container {
            position: relative;
            display: flex;
            align-items: center;
        }

        .search-input {
            width: 300px;
            padding: 8px 16px 8px 40px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--background-color);
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
            transition: all 0.2s ease;
        }

        .search-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgb(59 130 246 / 0.1);
        }

        .search-icon {
            position: absolute;
            left: 12px;
            color: var(--text-secondary);
            pointer-events: none;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .theme-toggle {
            background: none;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            font-size: 18px;
            transition: background-color 0.2s ease;
        }

        .theme-toggle:hover {
            background-color: var(--border-color);
        }

        .mobile-menu-button {
            display: none;
            background: none;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            font-size: 18px;
        }

        /* Sidebar */
        .sidebar {
            width: 320px;
            background-color: var(--surface-color);
            border-right: 1px solid var(--border-color);
            margin-top: 60px;
            overflow-y: auto;
            height: calc(100vh - 60px);
            position: fixed;
            left: 0;
            z-index: 900;
            transition: transform 0.3s ease;
        }

        .sidebar.collapsed {
            transform: translateX(-100%);
        }

        .sidebar-content {
            padding: 20px;
        }

        .sidebar-section {
            margin-bottom: 24px;
        }

        .sidebar-section h3 {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 12px;
        }

        .folder-item {
            margin-bottom: 8px;
        }

        .folder-header {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            user-select: none;
        }

        .folder-header:hover {
            background-color: var(--border-color);
        }

        .folder-header.active {
            background-color: var(--primary-color);
            color: white;
        }

        .folder-icon {
            margin-right: 8px;
            font-size: 16px;
            transition: transform 0.2s ease;
        }

        .folder-header.expanded .folder-icon {
            transform: rotate(90deg);
        }

        .folder-name {
            font-weight: 500;
            flex: 1;
        }

        .file-count {
            font-size: 12px;
            color: var(--text-secondary);
            background-color: var(--border-color);
            padding: 2px 6px;
            border-radius: 12px;
        }

        .file-list {
            margin-left: 24px;
            margin-top: 8px;
            display: none;
        }

        .file-list.expanded {
            display: block;
        }

        .file-item {
            display: flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            margin-bottom: 2px;
        }

        .file-item:hover {
            background-color: var(--border-color);
        }

        .file-item.active {
            background-color: var(--accent-color);
            color: white;
        }

        .file-icon {
            margin-right: 8px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .file-name {
            font-size: 14px;
            flex: 1;
        }

        .favorite-icon {
            margin-left: 8px;
            color: #f59e0b;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .file-item:hover .favorite-icon,
        .favorite-icon.active {
            opacity: 1;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 320px;
            margin-top: 60px;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 60px);
            transition: margin-left 0.3s ease;
        }

        .main-content.sidebar-collapsed {
            margin-left: 0;
        }

        .content-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--surface-color);
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .breadcrumb-separator {
            color: var(--text-secondary);
        }

        .content-title {
            font-size: 24px;
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .content-meta {
            display: flex;
            align-items: center;
            gap: 16px;
            font-size: 14px;
            color: var(--text-secondary);
            flex-wrap: wrap;
        }

        .content-meta .pdf-button {
            font-size: 12px;
            padding: 6px 10px;
        }

        .content-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            transition: opacity 0.2s ease;
        }

        .content-body.loading {
            opacity: 0.7;
        }

        .welcome-content {
            max-width: 800px;
            margin: 0 auto;
            text-align: center;
            padding: 60px 20px;
        }

        .welcome-title {
            font-size: 48px;
            font-weight: bold;
            margin-bottom: 16px;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .welcome-subtitle {
            font-size: 20px;
            color: var(--text-secondary);
            margin-bottom: 32px;
        }

        .welcome-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background-color: var(--surface-color);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: var(--primary-color);
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .quick-access {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 32px;
        }

        .quick-access-item {
            background-color: var(--surface-color);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            color: inherit;
        }

        .quick-access-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-color);
        }

        .quick-access-icon {
            font-size: 32px;
            margin-bottom: 12px;
        }

        .quick-access-title {
            font-weight: 600;
            margin-bottom: 8px;
        }

        .quick-access-desc {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* Markdown Content */
        .markdown-content {
            max-width: 800px;
            margin: 0 auto;
        }

        .markdown-content h1,
        .markdown-content h2,
        .markdown-content h3,
        .markdown-content h4,
        .markdown-content h5,
        .markdown-content h6 {
            margin: 24px 0 16px 0;
            color: var(--text-primary);
        }

        .markdown-content h1 {
            font-size: 32px;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 8px;
        }

        .markdown-content h2 {
            font-size: 24px;
        }

        .markdown-content h3 {
            font-size: 20px;
        }

        .markdown-content p {
            margin: 16px 0;
            line-height: 1.7;
        }

        .markdown-content ul,
        .markdown-content ol {
            margin: 16px 0;
            padding-left: 24px;
        }

        .markdown-content li {
            margin: 8px 0;
        }

        .markdown-content a {
            color: var(--primary-color);
            text-decoration: none;
            cursor: pointer;
            border-bottom: 1px solid transparent;
            transition: all 0.2s ease;
        }

        .markdown-content a:hover {
            text-decoration: none;
            border-bottom: 1px solid var(--primary-color);
            background-color: rgba(59, 130, 246, 0.1);
            padding: 2px 4px;
            border-radius: 3px;
        }

        .markdown-content a:active {
            background-color: rgba(59, 130, 246, 0.2);
        }

        .markdown-content code {
            background-color: var(--surface-color);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'SF Mono', 'Monaco', 'Cascadia Code', 'Roboto Mono', monospace;
            font-size: 0.9em;
        }

        .markdown-content pre {
            background-color: var(--surface-color);
            padding: 16px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 16px 0;
            border: 1px solid var(--border-color);
        }

        .markdown-content pre code {
            background: none;
            padding: 0;
        }

        .markdown-content blockquote {
            border-left: 4px solid var(--primary-color);
            padding-left: 16px;
            margin: 16px 0;
            color: var(--text-secondary);
            font-style: italic;
        }

        .markdown-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 16px 0;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            overflow: hidden;
            background-color: var(--background-color);
            font-size: 14px;
        }

        .markdown-content th,
        .markdown-content td {
            padding: 8px 12px;
            text-align: left;
            border-right: 1px solid var(--border-color);
            vertical-align: middle;
            line-height: 1.4;
        }

        .markdown-content th:last-child,
        .markdown-content td:last-child {
            border-right: none;
        }

        .markdown-content th {
            background-color: var(--surface-color);
            font-weight: 600;
            font-size: 13px;
            color: var(--text-primary);
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
        }

        .markdown-content td {
            border-bottom: 1px solid var(--border-color);
            font-size: 14px;
        }

        .markdown-content tbody tr:hover {
            background-color: rgba(59, 130, 246, 0.05);
            transition: background-color 0.15s ease;
        }

        .markdown-content tbody tr:last-child td {
            border-bottom: none;
        }

        /* Search Results */
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            max-height: 400px;
            overflow-y: auto;
            z-index: 1001;
            display: none;
        }

        .search-result-item {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .search-result-item:hover {
            background-color: var(--border-color);
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-title {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .search-result-path {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .search-result-snippet {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .search-highlight {
            background-color: var(--accent-color);
            color: white;
            padding: 1px 2px;
            border-radius: 2px;
        }

        /* Loading and Error States */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            font-size: 16px;
            color: var(--text-secondary);
        }

        .loading::before {
            content: '';
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-top: 2px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 12px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .theme-toggle:hover {
            background-color: var(--border-color);
            transform: scale(1.05);
        }

        .error {
            padding: 20px;
            text-align: center;
            color: #ef4444;
            background-color: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            margin: 20px;
        }

        .error-title {
            font-weight: 600;
            margin-bottom: 8px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .mobile-menu-button {
                display: block;
            }

            .search-container {
                display: none;
            }

            .sidebar {
                transform: translateX(-100%);
                width: 280px;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .welcome-title {
                font-size: 32px;
            }

            .welcome-stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .quick-access {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: 0 16px;
            }

            .sidebar-content {
                padding: 16px;
            }

            .content-body {
                padding: 16px;
            }

            .welcome-content {
                padding: 40px 16px;
            }

            .welcome-title {
                font-size: 28px;
            }

            .welcome-stats {
                grid-template-columns: 1fr;
            }

            .pdf-controls {
                flex-direction: column;
                gap: 12px;
            }

            .pdf-controls-left,
            .pdf-controls-right {
                justify-content: center;
            }

            .pdf-canvas-container {
                padding: 10px;
            }

            .content-meta .pdf-button {
                margin-left: 0 !important;
                margin-top: 8px;
                font-size: 11px;
                padding: 5px 8px;
                margin-right: 4px;
            }

            .content-meta {
                gap: 8px;
            }
        }

        /* PDF Viewer Styles */
        .pdf-viewer {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .pdf-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background-color: var(--surface-color);
            border-bottom: 1px solid var(--border-color);
            gap: 16px;
            flex-wrap: wrap;
        }

        .pdf-controls-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .pdf-controls-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .pdf-button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s ease;
        }

        .pdf-button:hover {
            background: var(--secondary-color);
        }

        .pdf-button:disabled {
            background: var(--border-color);
            color: var(--text-secondary);
            cursor: not-allowed;
        }

        .pdf-input {
            width: 60px;
            padding: 6px 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--background-color);
            color: var(--text-primary);
            text-align: center;
            font-size: 14px;
        }

        .pdf-info {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .pdf-canvas-container {
            flex: 1;
            overflow: auto;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            background-color: var(--background-color);
        }

        .pdf-canvas {
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-lg);
            max-width: 100%;
            height: auto;
        }

        .pdf-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 400px;
            font-size: 16px;
            color: var(--text-secondary);
        }

        .zoom-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .zoom-level {
            min-width: 60px;
            text-align: center;
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <button class="mobile-menu-button" onclick="toggleSidebar()">
                    ‚ò∞
                </button>
                <a href="#" class="logo" onclick="showWelcome()">ü§ñ AI Learning Journal</a>
                <div class="search-container">
                    <div class="search-icon">üîç</div>
                    <input type="text" class="search-input" placeholder="Search across all content..." 
                           oninput="handleSearch(this.value)" onblur="hideSearchResults()" onfocus="showSearchResults()">
                    <div class="search-results" id="searchResults"></div>
                </div>
            </div>
            <div class="header-right">
                <button class="theme-toggle" onclick="refreshRepository()" title="Refresh repository data">
                    <span id="refreshIcon">üîÑ</span>
                </button>
                <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">
                    <span id="themeIcon">üåô</span>
                </button>
            </div>
        </header>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-content">
                <div class="sidebar-section">
                    <h3>Categories</h3>
                    <div id="folderList"></div>
                </div>
                
                <div class="sidebar-section">
                    <h3>Recent Files</h3>
                    <div id="recentFiles"></div>
                </div>

                <div class="sidebar-section">
                    <h3>Favorites</h3>
                    <div id="favoriteFiles"></div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content" id="mainContent">
            <div class="content-header" id="contentHeader" style="display: none;">
                <div class="breadcrumb" id="breadcrumb"></div>
                <h1 class="content-title" id="contentTitle"></h1>
                <div class="content-meta" id="contentMeta"></div>
            </div>
            
            <div class="content-body" id="contentBody">
                <div class="welcome-content">
                    <h1 class="welcome-title">AI Learning Journal</h1>
                    <p class="welcome-subtitle">Comprehensive documentation and research notes on artificial intelligence, machine learning, and computer vision</p>
                    
                    <div class="welcome-stats" id="welcomeStats">
                        <div class="stat-card">
                            <div class="stat-value" id="totalFiles">-</div>
                            <div class="stat-label">Total Files</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="totalCategories">-</div>
                            <div class="stat-label">Categories</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="readFiles">0</div>
                            <div class="stat-label">Files Read</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="favoriteCount">0</div>
                            <div class="stat-label">Favorites</div>
                        </div>
                    </div>

                    <div class="quick-access">
                        <div class="quick-access-item" onclick="expandFolder('3D reconstruction')">
                            <div class="quick-access-icon">üèóÔ∏è</div>
                            <div class="quick-access-title">3D Reconstruction</div>
                            <div class="quick-access-desc">NeRF, Gaussian Splatting, and 3D vision techniques</div>
                        </div>
                        <div class="quick-access-item" onclick="expandFolder('LLM')">
                            <div class="quick-access-icon">üó£Ô∏è</div>
                            <div class="quick-access-title">Large Language Models</div>
                            <div class="quick-access-desc">GPT, LLaMA, and language model research</div>
                        </div>
                        <div class="quick-access-item" onclick="expandFolder('Diffusion_models_GAN')">
                            <div class="quick-access-icon">üé®</div>
                            <div class="quick-access-title">Generative Models</div>
                            <div class="quick-access-desc">Diffusion models, GANs, and image generation</div>
                        </div>
                        <div class="quick-access-item" onclick="expandFolder('Transformers&beyond')">
                            <div class="quick-access-icon">üîÄ</div>
                            <div class="quick-access-title">Transformers & Beyond</div>
                            <div class="quick-access-desc">Attention mechanisms and advanced architectures</div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Repository configuration
        const REPO_OWNER = 'linyuanthocr';
        const REPO_NAME = 'AI-Learning-Journal';
        const GITHUB_API_BASE = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}`;
        const GITHUB_RAW_BASE = `https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/main`;
        
        // Helper function to try fallback image URLs
        function tryFallbackImage(imgElement, fallbackUrls, altText) {
            if (fallbackUrls.length === 0) {
                // No more fallbacks, show error message
                imgElement.style.display = 'none';
                imgElement.nextElementSibling.style.display = 'block';
                return;
            }
            
            const nextUrl = fallbackUrls.shift();
            imgElement.onerror = () => tryFallbackImage(imgElement, fallbackUrls, altText);
            imgElement.src = nextUrl;
        }

        // Application state
        let repositoryData = {};
        let allFiles = [];
        let searchIndex = [];
        let currentFile = null;
        let favorites = JSON.parse(localStorage.getItem('ai-journal-favorites') || '[]');
        let recentFiles = JSON.parse(localStorage.getItem('ai-journal-recent') || '[]');
        let readFiles = JSON.parse(localStorage.getItem('ai-journal-read') || '[]');
        let lastCacheUpdate = localStorage.getItem('ai-journal-cache-timestamp');
        const CACHE_DURATION = 30 * 60 * 1000; // 30 minutes

        // PDF viewer state
        let currentPdf = null;
        let currentPdfPage = 1;
        let pdfScale = 1.0;
        let pdfNumPages = 0;

        // Initialize application
        async function initializeApp() {
            try {
                // Initialize PDF.js worker path early
                if (typeof pdfjsLib !== 'undefined') {
                    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                    console.log('PDF.js initialized successfully');
                } else {
                    console.warn('PDF.js library not loaded - PDF viewing will not work');
                }
                
                showLoading('Loading repository data...');
                
                // Check if we should use cached data
                const cachedData = localStorage.getItem('ai-journal-cached-data');
                const now = Date.now();
                const shouldRefresh = !lastCacheUpdate || 
                                    (now - parseInt(lastCacheUpdate)) > CACHE_DURATION || 
                                    !cachedData;
                
                if (cachedData && !shouldRefresh) {
                    console.log('Using cached repository data');
                    loadFromCache();
                    renderSidebar();
                    updateStats();
                    showWelcome();
                    showNotification('üìÅ Loaded from cache. Click refresh to update.', 'info');
                } else {
                    await loadRepositoryStructure();
                    renderSidebar();
                    updateStats();
                    showWelcome();
                }
            } catch (error) {
                console.error('Failed to initialize app:', error);
                
                // If we have fallback data, use it
                if (Object.keys(repositoryData).length > 0) {
                    console.log('Using fallback data');
                    renderSidebar();
                    updateStats();
                    showWelcome();
                    
                    // Show a warning but don't block the app
                    setTimeout(() => {
                        showNotification('‚ö†Ô∏è Using cached data. Some content may not be up to date.', 'warning');
                    }, 1000);
                } else {
                    showError('Failed to load repository data. Please check your internet connection and try again.');
                }
            }
        }

        // Load from cache
        function loadFromCache() {
            const cachedData = localStorage.getItem('ai-journal-cached-data');
            if (cachedData) {
                const parsed = JSON.parse(cachedData);
                repositoryData = parsed.repositoryData || {};
                allFiles = parsed.allFiles || [];
            }
        }

        // Save to cache
        function saveToCache() {
            const cacheData = {
                repositoryData,
                allFiles,
                timestamp: Date.now()
            };
            localStorage.setItem('ai-journal-cached-data', JSON.stringify(cacheData));
            localStorage.setItem('ai-journal-cache-timestamp', Date.now().toString());
        }

        // Refresh repository data
        async function refreshRepository() {
            const refreshIcon = document.getElementById('refreshIcon');
            refreshIcon.style.animation = 'spin 1s linear infinite';
            
            try {
                showLoading('Refreshing repository data...');
                
                // Clear cache
                repositoryData = {};
                allFiles = [];
                
                await loadRepositoryStructure();
                renderSidebar();
                updateStats();
                showWelcome();
                
                showNotification('‚úÖ Repository data refreshed!', 'info');
            } catch (error) {
                console.error('Failed to refresh:', error);
                showNotification('‚ùå Failed to refresh data', 'warning');
            } finally {
                refreshIcon.style.animation = '';
            }
        }

        // Load repository structure from GitHub API
        async function loadRepositoryStructure() {
            try {
                console.log('Loading repository structure...');
                console.log('GitHub API URL:', `${GITHUB_API_BASE}/contents`);
                
                const response = await fetch(`${GITHUB_API_BASE}/contents`);
                console.log('API Response status:', response.status, response.statusText);
                
                if (!response.ok) {
                    console.error('GitHub API error - response not ok:', response.status, response.statusText);
                    throw new Error(`GitHub API error: ${response.status} ${response.statusText}`);
                }
                
                const contents = await response.json();
                console.log('Repository contents loaded:', contents.length, 'items');
                console.log('Contents:', contents);
                
                // Filter directories and load their contents
                const directories = contents.filter(item => item.type === 'dir' && !item.name.startsWith('.'));
                console.log('Found directories:', directories.map(d => d.name));
                
                if (directories.length === 0) {
                    console.warn('No directories found, using fallback structure');
                    await loadFallbackStructure();
                    return;
                }
                
                for (const dir of directories) {
                    console.log(`Loading directory: ${dir.name}`);
                    await loadDirectoryContents(dir.name);
                }
                
                console.log('Repository structure loaded successfully');
                console.log('Final repositoryData:', repositoryData);
                console.log('Total files loaded:', allFiles.length);
                saveToCache();
            } catch (error) {
                console.error('Failed to load repository structure:', error);
                
                // Fallback: Use hardcoded structure if API fails
                console.log('Using fallback structure due to error');
                await loadFallbackStructure();
            }
        }

        // Fallback structure when API fails
        async function loadFallbackStructure() {
            console.log('Using fallback repository structure...');
            
            // Hardcoded structure based on repository analysis
            const fallbackData = {
                '3D reconstruction': {
                    name: '3D reconstruction',
                    displayName: '3D Reconstruction',
                    files: [
                        { name: '3D Gaussian Splatting for Real-Time Radiance Field.md', displayName: '3D Gaussian Splatting for Real-Time Radiance Field', path: '3D reconstruction/3D Gaussian Splatting for Real-Time Radiance Field.md', type: 'markdown' },
                        { name: 'NeRF Representing Scenes as Neural Radiance Fields.md', displayName: 'NeRF Representing Scenes as Neural Radiance Fields', path: '3D reconstruction/NeRF Representing Scenes as Neural Radiance Fields.md', type: 'markdown' },
                        { name: 'DUSt3R Geometric 3D Vision Made Easy.md', displayName: 'DUSt3R Geometric 3D Vision Made Easy', path: '3D reconstruction/DUSt3R Geometric 3D Vision Made Easy.md', type: 'markdown' },
                        { name: 'Instant Neural Graphics Primitives_Instant-NGP.md', displayName: 'Instant Neural Graphics Primitives Instant NGP', path: '3D reconstruction/Instant Neural Graphics Primitives_Instant-NGP.md', type: 'markdown' }
                    ]
                },
                'CNN_DL': {
                    name: 'CNN_DL',
                    displayName: 'CNN & Deep Learning',
                    files: [
                        { name: 'Batch Normalization.md', displayName: 'Batch Normalization', path: 'CNN_DL/Batch Normalization.md', type: 'markdown' },
                        { name: 'ResNet Architecture.md', displayName: 'ResNet Architecture', path: 'CNN_DL/ResNet Architecture.md', type: 'markdown' },
                        { name: 'UNet.md', displayName: 'UNet', path: 'CNN_DL/UNet.md', type: 'markdown' },
                        { name: 'Knowledge Distillation.md', displayName: 'Knowledge Distillation', path: 'CNN_DL/Knowledge Distillation.md', type: 'markdown' }
                    ]
                },
                'Diffusion_models_GAN': {
                    name: 'Diffusion_models_GAN',
                    displayName: 'Diffusion Models & GAN',
                    files: [
                        { name: 'Popular Diffusion models.md', displayName: 'Popular Diffusion Models', path: 'Diffusion_models_GAN/Popular Diffusion models.md', type: 'markdown' },
                        { name: 'StableDiffussion.md', displayName: 'Stable Diffusion', path: 'Diffusion_models_GAN/StableDiffussion.md', type: 'markdown' },
                        { name: 'What are Diffusion Models.md', displayName: 'What are Diffusion Models', path: 'Diffusion_models_GAN/What are Diffusion Models.md', type: 'markdown' },
                        { name: 'VQVAE_notes.md', displayName: 'VQ VAE Notes', path: 'Diffusion_models_GAN/VQVAE_notes.md', type: 'markdown' }
                    ]
                },
                'Generative AI': {
                    name: 'Generative AI',
                    displayName: 'Generative AI',
                    files: [
                        { name: 'Generative AI for Beginners.md', displayName: 'Generative AI for Beginners', path: 'Generative AI/Generative AI for Beginners.md', type: 'markdown' },
                        { name: 'Lora training.md', displayName: 'LoRA Training', path: 'Generative AI/Lora training.md', type: 'markdown' },
                        { name: 'Training lora.md', displayName: 'Training LoRA', path: 'Generative AI/Training lora.md', type: 'markdown' }
                    ]
                },
                'LLM': {
                    name: 'LLM',
                    displayName: 'Large Language Models',
                    files: [
                        { name: 'Generalized Language Models.md', displayName: 'Generalized Language Models', path: 'LLM/Generalized Language Models.md', type: 'markdown' },
                        { name: 'Instruct GPT.md', displayName: 'Instruct GPT', path: 'LLM/Instruct GPT.md', type: 'markdown' },
                        { name: 'LORA.md', displayName: 'LoRA', path: 'LLM/LORA.md', type: 'markdown' },
                        { name: 'PALM.md', displayName: 'PaLM', path: 'LLM/PALM.md', type: 'markdown' },
                        { name: 'RAG survey.md', displayName: 'RAG Survey', path: 'LLM/RAG survey.md', type: 'markdown' },
                        { name: 'Self_instruct.md', displayName: 'Self Instruct', path: 'LLM/Self_instruct.md', type: 'markdown' }
                    ]
                },
                'Transformers&beyond': {
                    name: 'Transformers&beyond',
                    displayName: 'Transformers & Beyond',
                    files: [
                        { name: 'Flash Attention.md', displayName: 'Flash Attention', path: 'Transformers&beyond/Flash Attention.md', type: 'markdown' },
                        { name: 'Transformer Family 2 0.md', displayName: 'Transformer Family 2.0', path: 'Transformers&beyond/Transformer Family 2 0.md', type: 'markdown' },
                        { name: 'ViT.md', displayName: 'Vision Transformer', path: 'Transformers&beyond/ViT.md', type: 'markdown' },
                        { name: 'Mamba.md', displayName: 'Mamba', path: 'Transformers&beyond/Mamba.md', type: 'markdown' },
                        { name: 'IMAGEBIND.md', displayName: 'ImageBind', path: 'Transformers&beyond/IMAGEBIND.md', type: 'markdown' }
                    ]
                }
            };
            
            // Populate repository data with fallback
            console.log('Processing fallback data with', Object.keys(fallbackData).length, 'categories');
            Object.entries(fallbackData).forEach(([key, data]) => {
                console.log(`Processing category: ${key} with ${data.files.length} files`);
                repositoryData[key] = data;
                
                // Add files to search index
                data.files.forEach(file => {
                    allFiles.push({
                        ...file,
                        category: key,
                        categoryDisplayName: data.displayName,
                        downloadUrl: `${GITHUB_RAW_BASE}/${file.path.replace(/ /g, '%20')}`
                    });
                });
            });
            
            console.log('Fallback data loaded - repositoryData:', Object.keys(repositoryData));
            console.log('Total files in allFiles:', allFiles.length);
        }

        // Load contents of a specific directory
        async function loadDirectoryContents(dirName) {
            try {
                const url = `${GITHUB_API_BASE}/contents/${encodeURIComponent(dirName)}`;
                console.log(`Loading directory contents for: ${dirName}`);
                console.log(`Directory API URL: ${url}`);
                
                const response = await fetch(url);
                console.log(`Directory ${dirName} response:`, response.status, response.statusText);
                
                if (!response.ok) {
                    console.error(`Failed to load directory ${dirName}:`, response.status, response.statusText);
                    return;
                }
                
                const contents = await response.json();
                console.log(`Raw contents in ${dirName}:`, contents.length, 'items');
                const files = contents.filter(item => 
                    item.type === 'file' && 
                    (item.name.endsWith('.md') || item.name.endsWith('.pdf')) &&
                    !item.name.startsWith('.')
                );
                console.log(`Filtered files in ${dirName}:`, files.length, 'items');
                console.log(`File names:`, files.map(f => f.name));
                
                // Process files and handle duplicate display names
                const processedFiles = [];
                const displayNameCounts = {};
                
                files.forEach(file => {
                    let displayName = formatFileDisplayName(file.name);
                    
                    // Handle duplicates by adding numbers
                    if (displayNameCounts[displayName]) {
                        displayNameCounts[displayName]++;
                        displayName = `${displayName} (${displayNameCounts[displayName]})`;
                    } else {
                        displayNameCounts[displayName] = 1;
                    }
                    
                    processedFiles.push({
                        name: file.name,
                        displayName: displayName,
                        path: file.path,
                        downloadUrl: file.download_url,
                        size: file.size,
                        type: file.name.endsWith('.md') ? 'markdown' : 'pdf'
                    });
                });
                
                repositoryData[dirName] = {
                    name: dirName,
                    displayName: formatDisplayName(dirName),
                    files: processedFiles
                };
                
                // Add files to search index
                processedFiles.forEach(file => {
                    allFiles.push({
                        name: file.name,
                        displayName: file.displayName,
                        path: file.path,
                        category: dirName,
                        categoryDisplayName: formatDisplayName(dirName),
                        downloadUrl: file.downloadUrl,
                        size: file.size,
                        type: file.type
                    });
                });
            } catch (error) {
                console.error(`Failed to load directory ${dirName}:`, error);
            }
        }

        // Format display names
        function formatDisplayName(name) {
            return name
                .replace(/[_&]/g, ' ')
                .split(' ')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ');
        }

        function formatFileDisplayName(filename) {
            let nameWithoutExt = filename.replace(/\.(md|pdf)$/, '');
            
            // Only remove hash at the very end - be more specific
            nameWithoutExt = nameWithoutExt
                // Remove space + hash at end (like " 4a81adda3eb6405cbe8db8685390307b")
                .replace(/\s+[a-f0-9]{32}$/i, '')
                .replace(/\s+[a-f0-9]{20,}$/i, '');
            
            // Remove dates only at beginning or end
            nameWithoutExt = nameWithoutExt
                .replace(/^\d{4}\.\d{2}\.\d{2}\s+/g, '') // Remove dates like "2019.07.14 " at start
                .replace(/^\d{4}-\d{2}-\d{2}\s+/g, '') // Remove dates like "2019-07-14 " at start
                .replace(/\s+\d{4}\.\d{2}\.\d{2}$/g, '') // Remove dates at end
                .replace(/\s+\d{4}-\d{2}-\d{2}$/g, ''); // Remove dates at end
            
            // Clean up the name
            return nameWithoutExt
                .replace(/[_-]/g, ' ')
                .replace(/([a-z])([A-Z])/g, '$1 $2')
                .replace(/\s+/g, ' ') // Replace multiple spaces with single space
                .trim()
                .split(' ')
                .filter(word => word.length > 0) // Remove empty words
                .map(word => {
                    // Keep common abbreviations uppercase
                    if (['AI', 'ML', 'DL', 'CNN', 'RNN', 'LSTM', 'GAN', 'VAE', 'API', 'GPU', 'CPU', 'LLM', 'GPT', 'GPT2', 'GPT3', 'GPT4', 'BERT', 'ViT', 'CLIP', 'SLAM', 'NeRF', '3D', '2D', 'VINS', 'MAE', 'DDPM', 'VQVAE', 'PIX2PIX'].includes(word.toUpperCase())) {
                        return word.toUpperCase();
                    }
                    // Capitalize first letter of other words
                    return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
                })
                .join(' ')
                .substring(0, 60) // Limit to 60 characters
                .trim();
        }

        // Render sidebar
        function renderSidebar() {
            console.log('renderSidebar called');
            console.log('repositoryData keys:', Object.keys(repositoryData));
            console.log('repositoryData:', repositoryData);
            
            const folderList = document.getElementById('folderList');
            if (!folderList) {
                console.error('folderList element not found!');
                return;
            }
            
            folderList.innerHTML = '';
            
            if (Object.keys(repositoryData).length === 0) {
                console.warn('No repository data to render');
                folderList.innerHTML = '<p style="color: var(--text-secondary); padding: 16px;">No categories found. Please refresh to reload data.</p>';
                return;
            }
            
            Object.entries(repositoryData).sort().forEach(([folderName, folderData]) => {
                console.log(`Rendering folder: ${folderName} with ${folderData.files.length} files`);
                const folderElement = createFolderElement(folderData);
                folderList.appendChild(folderElement);
            });
            
            renderRecentFiles();
            renderFavoriteFiles();
        }

        // Create folder element
        function createFolderElement(folderData) {
            const folderDiv = document.createElement('div');
            folderDiv.className = 'folder-item';
            
            const headerDiv = document.createElement('div');
            headerDiv.className = 'folder-header';
            headerDiv.onclick = () => toggleFolder(folderData.name);
            
            headerDiv.innerHTML = `
                <span class="folder-icon">‚ñ∂</span>
                <span class="folder-name">${folderData.displayName}</span>
                <span class="file-count">${folderData.files.length}</span>
            `;
            
            const fileList = document.createElement('div');
            fileList.className = 'file-list';
            fileList.id = `files-${folderData.name}`;
            
            folderData.files.forEach(file => {
                const fileElement = createFileElement(file, folderData.name);
                fileList.appendChild(fileElement);
            });
            
            folderDiv.appendChild(headerDiv);
            folderDiv.appendChild(fileList);
            
            return folderDiv;
        }

        // Create file element
        function createFileElement(file, categoryName) {
            const fileDiv = document.createElement('div');
            fileDiv.className = 'file-item';
            fileDiv.onclick = () => loadFile(file, categoryName);
            
            const icon = file.type === 'markdown' ? 'üìÑ' : 'üìã';
            const isFavorite = favorites.includes(file.path);
            
            fileDiv.innerHTML = `
                <span class="file-icon">${icon}</span>
                <span class="file-name">${file.displayName}</span>
                <span class="favorite-icon ${isFavorite ? 'active' : ''}" 
                      onclick="event.stopPropagation(); toggleFavorite('${file.path}')">
                    ‚≠ê
                </span>
            `;
            
            return fileDiv;
        }

        // Toggle folder expansion
        function toggleFolder(folderName) {
            const header = document.querySelector(`[onclick*="${folderName}"]`);
            const fileList = document.getElementById(`files-${folderName}`);
            
            header.classList.toggle('expanded');
            fileList.classList.toggle('expanded');
        }

        // Expand folder (for quick access)
        function expandFolder(folderName) {
            const header = document.querySelector(`[onclick*="${folderName}"]`);
            const fileList = document.getElementById(`files-${folderName}`);
            
            if (header && fileList) {
                header.classList.add('expanded');
                fileList.classList.add('expanded');
                
                // Scroll to folder
                header.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // Load and display file
        async function loadFile(file, categoryName) {
            try {
                showLoading('Loading file...');
                console.log('Loading file:', file.path, 'URL:', file.downloadUrl);
                
                // Update UI first
                setActiveFile(file.path);
                
                if (file.type === 'pdf') {
                    // Load PDF inline
                    await showPdfContent(file, categoryName);
                } else {
                    // Construct GitHub raw URL if downloadUrl is not available
                    let fileUrl = file.downloadUrl;
                    if (!fileUrl) {
                        fileUrl = `${GITHUB_RAW_BASE}/${file.path}`;
                        console.log('Using constructed URL:', fileUrl);
                    }
                    
                    // Load markdown file
                    console.log('Fetching from URL:', fileUrl);
                    const response = await fetch(fileUrl, {
                        method: 'GET',
                        headers: {
                            'Accept': 'text/plain, text/markdown, */*',
                            'Content-Type': 'text/plain'
                        },
                        mode: 'cors'
                    });
                    
                    console.log('Response status:', response.status, response.statusText);
                    
                    if (!response.ok) {
                        // Try alternative URL construction
                        if (fileUrl.includes('%20')) {
                            const altUrl = fileUrl.replace(/%20/g, ' ');
                            console.log('Trying alternative URL without encoding:', altUrl);
                            const altResponse = await fetch(altUrl, {
                                method: 'GET',
                                headers: {
                                    'Accept': 'text/plain, text/markdown, */*',
                                    'Content-Type': 'text/plain'
                                },
                                mode: 'cors'
                            });
                            if (altResponse.ok) {
                                const content = await altResponse.text();
                                showFileContent(file, categoryName, content);
                                return;
                            }
                        }
                        throw new Error(`HTTP ${response.status}: ${response.statusText}. URL: ${fileUrl}`);
                    }
                    
                    const content = await response.text();
                    console.log('File loaded successfully, content length:', content.length);
                    
                    showFileContent(file, categoryName, content);
                }
                
                // Update recent files and read tracking
                addToRecentFiles(file, categoryName);
                markAsRead(file.path);
                
                // Update URL hash for direct linking
                updateUrlHash(file.path);
                
            } catch (error) {
                console.error('Failed to load file:', error);
                console.error('File object:', file);
                showError(`Failed to load file: ${error.message}. Please check the browser console for more details.`);
            }
        }

        // Show file content
        function showFileContent(file, categoryName, content) {
            const contentHeader = document.getElementById('contentHeader');
            const breadcrumb = document.getElementById('breadcrumb');
            const contentTitle = document.getElementById('contentTitle');
            const contentMeta = document.getElementById('contentMeta');
            const contentBody = document.getElementById('contentBody');
            
            // Update breadcrumb
            breadcrumb.innerHTML = `
                <span onclick="showWelcome()" style="cursor: pointer; color: var(--primary-color);">Home</span>
                <span class="breadcrumb-separator">‚Ä∫</span>
                <span onclick="expandFolder('${categoryName}')" style="cursor: pointer; color: var(--primary-color);">${formatDisplayName(categoryName)}</span>
                <span class="breadcrumb-separator">‚Ä∫</span>
                <span>${file.displayName}</span>
            `;
            
            // Update title and meta
            contentTitle.textContent = file.displayName;
            contentMeta.innerHTML = `
                <span>üìÅ ${formatDisplayName(categoryName)}</span>
                <span>üìÑ ${file.type === 'markdown' ? 'Markdown' : 'PDF'}</span>
                <span>üìä ${formatFileSize(file.size || 0)}</span>
                <button class="pdf-button" onclick="downloadFile('${file.downloadUrl.replace(/'/g, "\\'")}', '${file.name.replace(/'/g, "\\'")}'); event.stopPropagation();" style="margin-left: 16px;">
                    üíæ Download
                </button>
                <button class="pdf-button" onclick="viewInGitHub('${file.path.replace(/'/g, "\\'")}'); event.stopPropagation();" style="margin-left: 8px;">
                    üìã View in GitHub
                </button>
                <button class="pdf-button" onclick="copyFileLink('${file.path.replace(/'/g, "\\'")}'); event.stopPropagation();" style="margin-left: 8px;">
                    üîó Copy Link
                </button>
            `;
            
            // Show header and render content
            contentHeader.style.display = 'block';
            contentBody.classList.remove('loading');
            contentBody.innerHTML = `<div class="markdown-content">${renderMarkdown(content, file.path)}</div>`;
            
            // Apply syntax highlighting
            if (window.Prism) {
                Prism.highlightAllUnder(contentBody);
            }
            
            // Re-render MathJax equations
            if (window.MathJax) {
                MathJax.typesetPromise([contentBody]).catch(function (err) {
                    console.log('MathJax typeset failed: ' + err.message);
                });
            }
            
            currentFile = { ...file, categoryName };
        }

        // Show PDF content
        async function showPdfContent(file, categoryName) {
            const contentHeader = document.getElementById('contentHeader');
            const breadcrumb = document.getElementById('breadcrumb');
            const contentTitle = document.getElementById('contentTitle');
            const contentMeta = document.getElementById('contentMeta');
            const contentBody = document.getElementById('contentBody');
            
            // Update breadcrumb
            breadcrumb.innerHTML = `
                <span onclick="showWelcome()" style="cursor: pointer; color: var(--primary-color);">Home</span>
                <span class="breadcrumb-separator">‚Ä∫</span>
                <span onclick="expandFolder('${categoryName}')" style="cursor: pointer; color: var(--primary-color);">${formatDisplayName(categoryName)}</span>
                <span class="breadcrumb-separator">‚Ä∫</span>
                <span>${file.displayName}</span>
            `;
            
            // Update title and meta
            contentTitle.textContent = file.displayName;
            contentMeta.innerHTML = `
                <span>üìÅ ${formatDisplayName(categoryName)}</span>
                <span>üìã PDF Document</span>
                <span>üìä ${formatFileSize(file.size || 0)}</span>
            `;
            
            // Show header
            contentHeader.style.display = 'block';
            
            // Create PDF viewer HTML
            contentBody.innerHTML = `
                <div class="pdf-viewer">
                    <div class="pdf-controls">
                        <div class="pdf-controls-left">
                            <button class="pdf-button" onclick="previousPage()" id="prevPageBtn">
                                ‚óÄ Previous
                            </button>
                            <input type="number" class="pdf-input" id="pageInput" value="1" min="1" onchange="goToPage(this.value)">
                            <span class="pdf-info">of <span id="totalPages">-</span></span>
                            <button class="pdf-button" onclick="nextPage()" id="nextPageBtn">
                                Next ‚ñ∂
                            </button>
                        </div>
                        <div class="pdf-controls-right">
                            <div class="zoom-controls">
                                <button class="pdf-button" onclick="zoomOut()">üîç-</button>
                                <span class="zoom-level" id="zoomLevel">100%</span>
                                <button class="pdf-button" onclick="zoomIn()">üîç+</button>
                            </div>
                            <button class="pdf-button" onclick="downloadPdf()">
                                üíæ Download
                            </button>
                            <button class="pdf-button" onclick="viewInGitHub('${file.path.replace(/'/g, "\\'")}')">
                                üìã View in GitHub
                            </button>
                        </div>
                    </div>
                    <div class="pdf-canvas-container">
                        <div class="pdf-loading" id="pdfLoading">Loading PDF...</div>
                        <canvas id="pdfCanvas" class="pdf-canvas" style="display: none;"></canvas>
                    </div>
                </div>
            `;
            
            // Load the PDF with a small delay to ensure DOM is ready
            setTimeout(async () => {
                await loadPdf(file.downloadUrl);
            }, 100);
            
            currentFile = { ...file, categoryName };
        }

        // Load PDF using PDF.js
        async function loadPdf(url) {
            const loadingElement = document.getElementById('pdfLoading');
            
            try {
                console.log('Loading PDF from:', url);
                
                // Check if PDF.js is available
                if (typeof pdfjsLib === 'undefined') {
                    throw new Error('PDF.js library not loaded');
                }
                
                const loadingTask = pdfjsLib.getDocument(url);
                currentPdf = await loadingTask.promise;
                pdfNumPages = currentPdf.numPages;
                currentPdfPage = 1;
                
                console.log(`PDF loaded successfully: ${pdfNumPages} pages`);
                
                // Update UI with null checks
                const totalPagesElement = document.getElementById('totalPages');
                const pageInputElement = document.getElementById('pageInput');
                const pdfLoadingElement = document.getElementById('pdfLoading');
                const pdfCanvasElement = document.getElementById('pdfCanvas');
                
                if (totalPagesElement) {
                    totalPagesElement.textContent = pdfNumPages;
                }
                if (pageInputElement) {
                    pageInputElement.max = pdfNumPages;
                    pageInputElement.value = 1;
                }
                
                // Render first page
                await renderPdfPage(1);
                
                // Hide loading, show canvas
                if (pdfLoadingElement) {
                    pdfLoadingElement.style.display = 'none';
                }
                if (pdfCanvasElement) {
                    pdfCanvasElement.style.display = 'block';
                }
                
                updatePdfControls();
                updateZoomLevel();
                
            } catch (error) {
                console.error('Failed to load PDF:', error);
                if (loadingElement) {
                    loadingElement.innerHTML = `
                        <div style="text-align: center;">
                            <div style="color: #ef4444; margin-bottom: 12px;">‚ùå Failed to load PDF</div>
                            <div style="color: var(--text-secondary); margin-bottom: 16px;">${error.message}</div>
                            <button class="pdf-button" onclick="window.open('${url}', '_blank')">
                                Open in New Tab
                            </button>
                        </div>
                    `;
                }
            }
        }

        // Render a specific PDF page
        async function renderPdfPage(pageNum) {
            if (!currentPdf) return;
            
            try {
                const page = await currentPdf.getPage(pageNum);
                const canvas = document.getElementById('pdfCanvas');
                
                if (!canvas) {
                    console.error('PDF canvas element not found');
                    return;
                }
                
                const context = canvas.getContext('2d');
                
                // Calculate scale to fit container
                const containerWidth = canvas.parentElement.clientWidth - 40; // Account for padding
                const viewport = page.getViewport({ scale: 1.0 });
                const scale = Math.min(pdfScale, containerWidth / viewport.width);
                
                const scaledViewport = page.getViewport({ scale });
                
                // Set canvas dimensions
                canvas.height = scaledViewport.height;
                canvas.width = scaledViewport.width;
                
                // Render page
                const renderContext = {
                    canvasContext: context,
                    viewport: scaledViewport
                };
                
                await page.render(renderContext).promise;
                
                currentPdfPage = pageNum;
                
                // Update page input with null check
                const pageInputElement = document.getElementById('pageInput');
                if (pageInputElement) {
                    pageInputElement.value = pageNum;
                }
                
            } catch (error) {
                console.error('Failed to render PDF page:', error);
            }
        }

        // PDF navigation functions
        async function nextPage() {
            if (currentPdfPage < pdfNumPages) {
                await renderPdfPage(currentPdfPage + 1);
                updatePdfControls();
            }
        }

        async function previousPage() {
            if (currentPdfPage > 1) {
                await renderPdfPage(currentPdfPage - 1);
                updatePdfControls();
            }
        }

        async function goToPage(pageNum) {
            const page = parseInt(pageNum);
            if (page >= 1 && page <= pdfNumPages) {
                await renderPdfPage(page);
                updatePdfControls();
            }
        }

        // PDF zoom functions
        async function zoomIn() {
            pdfScale = Math.min(pdfScale * 1.2, 3.0);
            await renderPdfPage(currentPdfPage);
            updateZoomLevel();
        }

        async function zoomOut() {
            pdfScale = Math.max(pdfScale / 1.2, 0.5);
            await renderPdfPage(currentPdfPage);
            updateZoomLevel();
        }

        function updateZoomLevel() {
            const zoomElement = document.getElementById('zoomLevel');
            if (zoomElement) {
                zoomElement.textContent = Math.round(pdfScale * 100) + '%';
            }
        }

        function updatePdfControls() {
            const prevBtn = document.getElementById('prevPageBtn');
            const nextBtn = document.getElementById('nextPageBtn');
            
            if (prevBtn) {
                prevBtn.disabled = currentPdfPage <= 1;
            }
            if (nextBtn) {
                nextBtn.disabled = currentPdfPage >= pdfNumPages;
            }
        }

        function downloadPdf() {
            if (currentFile && currentFile.downloadUrl) {
                downloadFile(currentFile.downloadUrl, currentFile.name);
            }
        }

        // Generic download function
        function downloadFile(url, filename) {
            try {
                // Create a temporary link element
                const link = document.createElement('a');
                link.href = url;
                link.download = filename || 'download';
                link.target = '_blank';
                
                // Append to body, click, and remove
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showNotification(`üì• Downloading ${filename}`, 'info');
            } catch (error) {
                console.error('Download failed:', error);
                // Fallback to opening in new tab
                window.open(url, '_blank');
            }
        }

        // Copy direct link to file
        async function copyFileLink(filePath) {
            try {
                const url = `${window.location.origin}${window.location.pathname}#file:${encodeURIComponent(filePath)}`;
                await navigator.clipboard.writeText(url);
                showNotification('üîó Link copied to clipboard!', 'info');
            } catch (error) {
                console.error('Failed to copy link:', error);
                // Fallback for browsers that don't support clipboard API
                const url = `${window.location.origin}${window.location.pathname}#file:${encodeURIComponent(filePath)}`;
                prompt('Copy this link:', url);
            }
        }

        // View file in GitHub
        function viewInGitHub(filePath) {
            try {
                // Construct GitHub URL for the file
                const githubUrl = `https://github.com/${REPO_OWNER}/${REPO_NAME}/blob/main/${encodeURIComponent(filePath)}`;
                // Open in new tab
                window.open(githubUrl, '_blank');
                showNotification('üìã Opening in GitHub...', 'info');
            } catch (error) {
                console.error('Failed to open GitHub URL:', error);
                showNotification('‚ùå Failed to open GitHub URL', 'error');
            }
        }

        // Load file by path (for internal markdown links)
        async function loadFileByPath(filePath) {
            console.log('Attempting to load file by path:', filePath);
            
            // Clean up the file path
            let cleanPath = filePath.replace(/^\.\//, '').replace(/^\//, '');
            
            // Try different matching strategies
            let file = null;
            
            // 1. Exact path match
            file = allFiles.find(f => f.path === cleanPath);
            
            // 2. Filename match (case insensitive)
            if (!file) {
                const filename = cleanPath.split('/').pop().toLowerCase();
                file = allFiles.find(f => f.name.toLowerCase() === filename);
            }
            
            // 3. Partial path match
            if (!file) {
                file = allFiles.find(f => f.path.toLowerCase().includes(cleanPath.toLowerCase()));
            }
            
            // 4. Just filename without extension
            if (!file) {
                const baseFilename = cleanPath.replace(/\.(md|pdf)$/i, '');
                file = allFiles.find(f => f.name.toLowerCase().includes(baseFilename.toLowerCase()));
            }
            
            if (file) {
                console.log('Found file:', file.path);
                await loadFile(file, file.category);
                showNotification(`üìÑ Navigated to: ${file.displayName}`, 'info');
            } else {
                console.log('File not found, available files:', allFiles.map(f => f.path));
                showNotification(`‚ùå File not found: ${filePath}`, 'warning');
                
                // Try to suggest similar files
                const suggestions = allFiles.filter(f => 
                    f.name.toLowerCase().includes(cleanPath.toLowerCase()) ||
                    cleanPath.toLowerCase().includes(f.name.toLowerCase().replace(/\.(md|pdf)$/i, ''))
                ).slice(0, 3);
                
                if (suggestions.length > 0) {
                    setTimeout(() => {
                        showNotification(`üí° Similar files: ${suggestions.map(f => f.displayName).join(', ')}`, 'info');
                    }, 2000);
                }
            }
        }

        // Render markdown to HTML
        function renderMarkdown(markdown, filePath = '') {
            // Get the directory path for the current file to resolve relative images
            const fileDir = filePath ? filePath.substring(0, filePath.lastIndexOf('/')) : '';
            
            // Simple markdown parser - in production, use a library like marked.js
            let html = markdown
                // Headers
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                // Bold and italic
                .replace(/\*\*\*(.*?)\*\*\*/g, '<strong><em>$1</em></strong>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                // Code blocks with syntax highlighting (preserve line breaks)
                .replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
                    // Preserve line breaks and indentation in code blocks by protecting them
                    const cleanCode = code.trim();
                    return `<pre><code class="language-${lang || ''}">${cleanCode}</code></pre>`;
                })
                .replace(/```([\s\S]*?)```/g, (match, code) => {
                    // Preserve line breaks for code blocks without language
                    const cleanCode = code.trim();
                    return `<pre><code>${cleanCode}</code></pre>`;
                })
                .replace(/`([^`]+)`/g, '<code>$1</code>')
                // Process HTML img tags FIRST
                .replace(/<img([^>]*)\s+src=["']([^"']+)["']([^>]*)>/g, (match, beforeSrc, src, afterSrc) => {
                    // Extract alt text if present
                    const altMatch = match.match(/alt=["']([^"']*)["']/);
                    const alt = altMatch ? altMatch[1] : '';
                    
                    // Extract width/height if present
                    const widthMatch = match.match(/width=["']?([^"'\s>]+)["']?/);
                    const width = widthMatch ? widthMatch[1] : '';
                    
                    // Clean up the source path
                    let cleanSrc = src.replace(/%20/g, ' ').replace(/^\s+/, '');
                    cleanSrc = cleanSrc.replace(/^%[0-9a-fA-F]{2}/, '');
                    cleanSrc = cleanSrc.replace(/^[0-9a-fA-F]{32}\//, '');
                    
                    let absoluteSrc;
                    if (src.startsWith('http') || src.startsWith('//')) {
                        absoluteSrc = src;
                    } else {
                        // Construct GitHub raw URL for relative paths
                        if (cleanSrc.startsWith('./')) {
                            absoluteSrc = `${GITHUB_RAW_BASE}/${fileDir}/${cleanSrc.substring(2)}`;
                        } else if (cleanSrc.startsWith('../')) {
                            absoluteSrc = `${GITHUB_RAW_BASE}/${fileDir}/${cleanSrc}`;
                        } else if (cleanSrc.startsWith('images/')) {
                            absoluteSrc = `${GITHUB_RAW_BASE}/${fileDir}/${cleanSrc}`;
                        } else if (cleanSrc.includes('/')) {
                            absoluteSrc = `${GITHUB_RAW_BASE}/${fileDir}/${cleanSrc}`;
                        } else {
                            absoluteSrc = `${GITHUB_RAW_BASE}/${fileDir}/images/${cleanSrc}`;
                        }
                    }
                    
                    absoluteSrc = absoluteSrc.replace(/ /g, '%20');
                    
                    // Build style string
                    let style = 'max-width: 100%; height: auto; border-radius: 8px; margin: 16px 0;';
                    if (width) {
                        style += ` width: ${width}px;`;
                    }
                    
                    // Create fallback URLs for different possible locations
                    const categoryName = fileDir.split('/')[0];
                    const fallbackUrls = [];
                    
                    // Add standard image folder locations
                    fallbackUrls.push(`${GITHUB_RAW_BASE}/${categoryName}/images/SD/${cleanSrc}`.replace(/ /g, '%20'));
                    fallbackUrls.push(`${GITHUB_RAW_BASE}/${categoryName}/images/Popular%20Diffusion%20models/${cleanSrc}`.replace(/ /g, '%20'));
                    fallbackUrls.push(`${GITHUB_RAW_BASE}/${categoryName}/images/VQVAE/${cleanSrc}`.replace(/ /g, '%20'));
                    fallbackUrls.push(`${GITHUB_RAW_BASE}/${categoryName}/images/What%20are%20Diffusion%20Models/${cleanSrc}`.replace(/ /g, '%20'));
                    fallbackUrls.push(`${GITHUB_RAW_BASE}/${categoryName}/images/style%20transfer/${cleanSrc}`.replace(/ /g, '%20'));
                    
                    // Add document-specific folders with hash codes
                    fallbackUrls.push(`${GITHUB_RAW_BASE}/${categoryName}/Stable%20diffusion%203%20c73bab85d94944edbb991761fe6b6d06/${cleanSrc}`.replace(/ /g, '%20'));
                    fallbackUrls.push(`${GITHUB_RAW_BASE}/${categoryName}/Diffusion%20models%20for%20video%20generation%204a81adda3eb6405cbe8db8685390307b/${cleanSrc}`.replace(/ /g, '%20'));
                    fallbackUrls.push(`${GITHUB_RAW_BASE}/${categoryName}/InstructPix2Pix%20Learning%20to%20Follow%20Image%20Editing%20I%20873196964e104d4aa1fae9a777fd37f4/${cleanSrc}`.replace(/ /g, '%20'));
                    
                    return `<img src="${absoluteSrc}" alt="${alt}" style="${style}" onerror="tryFallbackImage(this, ${JSON.stringify(fallbackUrls)}, '${alt || cleanSrc}')" onload="this.nextElementSibling.style.display='none';"><div style="display: none; padding: 12px; background: var(--surface-color); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-secondary); text-align: center;">üì∑ Image not found: ${alt || cleanSrc}</div>`;
                    
                    return `<img src="${absoluteSrc}" alt="${alt}" style="${style}" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" onload="this.nextElementSibling.style.display='none';"><div style="display: none; padding: 12px; background: var(--surface-color); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-secondary); text-align: center;">üì∑ Image not found: ${alt || src}</div>`;
                })
                // Process markdown images SECOND
                .replace(/!\[([^\]]*)\]\(([^)]+)\)/g, (match, alt, src) => {
                    // If it's already an absolute URL, keep it as is
                    if (src.startsWith('http') || src.startsWith('//')) {
                        return `<img src="${src}" alt="${alt}" style="max-width: 100%; height: auto; border-radius: 8px; margin: 16px 0;">`;
                    }
                    
                    // For relative paths, construct the GitHub raw URL
                    let absoluteSrc;
                    // Clean up the source path by removing encoded spaces and other issues
                    let cleanSrc = src.replace(/%20/g, ' ').replace(/^\s+/, '');
                    
                    // Fix malformed paths that start with encoded characters
                    cleanSrc = cleanSrc.replace(/^%[0-9a-fA-F]{2}/, '');
                    
                    // Remove any leading hash codes or encoded content
                    cleanSrc = cleanSrc.replace(/^[0-9a-fA-F]{32}\//, '');
                    
                    if (cleanSrc.startsWith('./')) {
                        // Remove ./ and combine with file directory
                        absoluteSrc = `${GITHUB_RAW_BASE}/${fileDir}/${cleanSrc.substring(2)}`;
                    } else if (cleanSrc.startsWith('../')) {
                        // Handle parent directory navigation
                        absoluteSrc = `${GITHUB_RAW_BASE}/${fileDir}/${cleanSrc}`;
                    } else if (cleanSrc.startsWith('images/')) {
                        // Images folder relative to current directory
                        absoluteSrc = `${GITHUB_RAW_BASE}/${fileDir}/${cleanSrc}`;
                    } else if (cleanSrc.includes('/')) {
                        // Path includes folders - construct relative to file directory
                        absoluteSrc = `${GITHUB_RAW_BASE}/${fileDir}/${cleanSrc}`;
                    } else {
                        // Just a filename - use default images directory
                        absoluteSrc = `${GITHUB_RAW_BASE}/${fileDir}/images/${cleanSrc}`;
                    }
                    
                    // Encode the final URL properly
                    absoluteSrc = absoluteSrc.replace(/ /g, '%20');
                    
                    // Create fallback URLs for different possible locations
                    const categoryName = fileDir.split('/')[0];
                    const fallbackUrls = [];
                    
                    // Add standard image folder locations
                    fallbackUrls.push(`${GITHUB_RAW_BASE}/${categoryName}/images/SD/${cleanSrc}`.replace(/ /g, '%20'));
                    fallbackUrls.push(`${GITHUB_RAW_BASE}/${categoryName}/images/Popular%20Diffusion%20models/${cleanSrc}`.replace(/ /g, '%20'));
                    fallbackUrls.push(`${GITHUB_RAW_BASE}/${categoryName}/images/VQVAE/${cleanSrc}`.replace(/ /g, '%20'));
                    fallbackUrls.push(`${GITHUB_RAW_BASE}/${categoryName}/images/What%20are%20Diffusion%20Models/${cleanSrc}`.replace(/ /g, '%20'));
                    fallbackUrls.push(`${GITHUB_RAW_BASE}/${categoryName}/images/style%20transfer/${cleanSrc}`.replace(/ /g, '%20'));
                    
                    // Add document-specific folders with hash codes
                    fallbackUrls.push(`${GITHUB_RAW_BASE}/${categoryName}/Stable%20diffusion%203%20c73bab85d94944edbb991761fe6b6d06/${cleanSrc}`.replace(/ /g, '%20'));
                    fallbackUrls.push(`${GITHUB_RAW_BASE}/${categoryName}/Diffusion%20models%20for%20video%20generation%204a81adda3eb6405cbe8db8685390307b/${cleanSrc}`.replace(/ /g, '%20'));
                    fallbackUrls.push(`${GITHUB_RAW_BASE}/${categoryName}/InstructPix2Pix%20Learning%20to%20Follow%20Image%20Editing%20I%20873196964e104d4aa1fae9a777fd37f4/${cleanSrc}`.replace(/ /g, '%20'));
                    
                    return `<img src="${absoluteSrc}" alt="${alt}" style="max-width: 100%; height: auto; border-radius: 8px; margin: 16px 0;" onerror="tryFallbackImage(this, ${JSON.stringify(fallbackUrls)}, '${alt || cleanSrc}')" onload="this.nextElementSibling.style.display='none';"><div style="display: none; padding: 12px; background: var(--surface-color); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-secondary); text-align: center;">üì∑ Image not found: ${alt || cleanSrc}</div>`;
                    
                    return `<img src="${absoluteSrc}" alt="${alt}" style="max-width: 100%; height: auto; border-radius: 8px; margin: 16px 0;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" onload="this.nextElementSibling.style.display='none';"><div style="display: none; padding: 12px; background: var(--surface-color); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-secondary); text-align: center;">üì∑ Image not found: ${alt || src}</div>`;
                })
                // Process markdown links SECOND
                .replace(/\[([^\]]+)\]\(([^)]+)\)/g, (match, text, url) => {
                    // Check if this is actually an image that should have been processed as ![](url)
                    if (url.match(/\.(png|jpg|jpeg|gif|bmp|webp|svg)$/i)) {
                        // This is an image referenced as a link - convert to image
                        let absoluteSrc;
                        let cleanUrl = url.replace(/%20/g, ' ').replace(/^\s+/, '');
                        
                        // Fix malformed paths that start with encoded characters
                        cleanUrl = cleanUrl.replace(/^%[0-9a-fA-F]{2}/, '');
                        
                        // Remove any leading hash codes or encoded content
                        cleanUrl = cleanUrl.replace(/^[0-9a-fA-F]{32}\//, '');
                        
                        if (cleanUrl.startsWith('http') || cleanUrl.startsWith('//')) {
                            absoluteSrc = cleanUrl;
                        } else if (cleanUrl.startsWith('./')) {
                            absoluteSrc = `${GITHUB_RAW_BASE}/${fileDir}/${cleanUrl.substring(2)}`;
                        } else if (cleanUrl.startsWith('images/')) {
                            absoluteSrc = `${GITHUB_RAW_BASE}/${fileDir}/${cleanUrl}`;
                        } else if (cleanUrl.includes('/')) {
                            absoluteSrc = `${GITHUB_RAW_BASE}/${fileDir}/${cleanUrl}`;
                        } else {
                            absoluteSrc = `${GITHUB_RAW_BASE}/${fileDir}/images/${cleanUrl}`;
                        }
                        
                        // Encode the final URL properly
                        absoluteSrc = absoluteSrc.replace(/ /g, '%20');
                        
                        // Create fallback URLs for different possible locations
                        const categoryName = fileDir.split('/')[0];
                        const fallbackUrls = [];
                        
                        // Add standard image folder locations
                        fallbackUrls.push(`${GITHUB_RAW_BASE}/${categoryName}/images/SD/${cleanUrl}`.replace(/ /g, '%20'));
                        fallbackUrls.push(`${GITHUB_RAW_BASE}/${categoryName}/images/Popular%20Diffusion%20models/${cleanUrl}`.replace(/ /g, '%20'));
                        fallbackUrls.push(`${GITHUB_RAW_BASE}/${categoryName}/images/VQVAE/${cleanUrl}`.replace(/ /g, '%20'));
                        fallbackUrls.push(`${GITHUB_RAW_BASE}/${categoryName}/images/What%20are%20Diffusion%20Models/${cleanUrl}`.replace(/ /g, '%20'));
                        fallbackUrls.push(`${GITHUB_RAW_BASE}/${categoryName}/images/style%20transfer/${cleanUrl}`.replace(/ /g, '%20'));
                        
                        // Add document-specific folders with hash codes
                        fallbackUrls.push(`${GITHUB_RAW_BASE}/${categoryName}/Stable%20diffusion%203%20c73bab85d94944edbb991761fe6b6d06/${cleanUrl}`.replace(/ /g, '%20'));
                        fallbackUrls.push(`${GITHUB_RAW_BASE}/${categoryName}/Diffusion%20models%20for%20video%20generation%204a81adda3eb6405cbe8db8685390307b/${cleanUrl}`.replace(/ /g, '%20'));
                        fallbackUrls.push(`${GITHUB_RAW_BASE}/${categoryName}/InstructPix2Pix%20Learning%20to%20Follow%20Image%20Editing%20I%20873196964e104d4aa1fae9a777fd37f4/${cleanUrl}`.replace(/ /g, '%20'));
                        
                        return `<img src="${absoluteSrc}" alt="${text}" style="max-width: 100%; height: auto; border-radius: 8px; margin: 16px 0;" onerror="tryFallbackImage(this, ${JSON.stringify(fallbackUrls)}, '${text}')" onload="this.nextElementSibling.style.display='none';"><div style="display: none; padding: 12px; background: var(--surface-color); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-secondary); text-align: center;">üì∑ Image not found: ${text}</div>`;
                        
                        return `<img src="${absoluteSrc}" alt="${text}" style="max-width: 100%; height: auto; border-radius: 8px; margin: 16px 0;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" onload="this.nextElementSibling.style.display='none';"><div style="display: none; padding: 12px; background: var(--surface-color); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-secondary); text-align: center;">üì∑ Image not found: ${text}</div>`;
                    }
                    
                    // Handle different types of links
                    if (url.startsWith('http') || url.startsWith('//')) {
                        // External link - open in new tab
                        return `<a href="${url}" target="_blank">${text}</a>`;
                    } else if (url.endsWith('.md')) {
                        // Internal markdown file link
                        const cleanUrl = url.replace(/^\.\//, ''); // Remove leading ./
                        return `<a href="#" onclick="loadFileByPath('${cleanUrl}'); return false;">${text}</a>`;
                    } else if (url.endsWith('.pdf')) {
                        // PDF link - open in new tab
                        const absoluteUrl = url.startsWith('http') ? url : `${GITHUB_RAW_BASE}/${fileDir}/${url}`;
                        return `<a href="${absoluteUrl}" target="_blank">${text} üìã</a>`;
                    } else if (url.startsWith('#')) {
                        // Anchor link within same document
                        return `<a href="${url}">${text}</a>`;
                    } else {
                        // Other relative links - treat as external
                        return `<a href="${url}" target="_blank">${text}</a>`;
                    }
                })
                // Convert arxiv links FIRST (both with and without https://)
                .replace(/(^|[^[\(<a])(https?:\/\/)?(arxiv\.org\/abs\/[\d\.]+)/g, (match, prefix, protocol, path) => {
                    // Only show the arxiv.org/abs/... part, not the full URL
                    const url = protocol ? `${protocol}${path}` : `https://${path}`;
                    return `${prefix}<a href="${url}" target="_blank">${path}</a>`;
                })
                // Process other plain URLs LAST (but skip arxiv URLs)
                .replace(/(^|[^"'=\/>])(https?:\/\/[^\s<>"\],]+)/g, (match, prefix, url) => {
                    // Skip if this URL is already processed or contains arxiv
                    if (match.includes('href=') || match.includes('src=') || match.includes('target=') || url.includes('arxiv.org')) {
                        return match;
                    }
                    // Clean up URL (remove trailing punctuation)
                    const cleanUrl = url.replace(/[.,;!?]+$/, '');
                    return `${prefix}<a href="${cleanUrl}" target="_blank">${cleanUrl}</a>`;
                })
                // Convert DOI patterns
                .replace(/(^|[^[\(<a])(doi:[\w\.\/\-]+)/g, (match, prefix, doi) => {
                    const url = `https://doi.org/${doi.replace('doi:', '')}`;
                    return `${prefix}<a href="${url}" target="_blank">${doi}</a>`;
                })
                // Lists
                .replace(/^\* (.+)$/gim, '<li>$1</li>')
                .replace(/^- (.+)$/gim, '<li>$1</li>')
                .replace(/^\d+\. (.+)$/gim, '<li>$1</li>')
                // Tables - simple and reliable processing
                .replace(/\|(.+)\|/g, (match, content) => {
                    const cells = content.split('|').map(cell => cell.trim()).filter(cell => cell.length > 0);
                    if (cells.length === 0) return match;
                    
                    // Check if this is a separator row (contains only - and |)
                    if (cells.every(cell => /^[-:\s]+$/.test(cell))) {
                        return ''; // Remove separator rows
                    }
                    
                    const cellTags = cells.map(cell => `<td>${cell}</td>`).join('');
                    return `<tr>${cellTags}</tr>`;
                })
                // Line breaks (but preserve code block formatting)
                .replace(/\n\n/g, '</p><p>');
            
            // Apply line breaks only outside of code blocks
            html = html.replace(/\n/g, (match, offset, string) => {
                // Check if we're inside a <pre><code> block
                const beforeMatch = string.substring(0, offset);
                const openTags = (beforeMatch.match(/<pre><code/g) || []).length;
                const closeTags = (beforeMatch.match(/<\/code><\/pre>/g) || []).length;
                
                // If we're inside a code block, preserve the newline as is
                if (openTags > closeTags) {
                    return '\n';
                }
                // Otherwise convert to <br>
                return '<br>';
            });
            
            // Wrap in paragraphs
            html = '<p>' + html + '</p>';
            
            // Clean up
            html = html
                .replace(/<p><\/p>/g, '')
                .replace(/<p>(<h[1-6]>)/g, '$1')
                .replace(/(<\/h[1-6]>)<\/p>/g, '$1')
                .replace(/<p>(<pre>)/g, '$1')
                .replace(/(<\/pre>)<\/p>/g, '$1')
                .replace(/<p>(<img)/g, '$1')
                .replace(/(\/div>)<\/p>/g, '$1')
                .replace(/<br><li>/g, '<li>')
                .replace(/<\/li><br>/g, '</li>')
                .replace(/<p>(<tr>)/g, '$1')
                .replace(/(<\/tr>)<\/p>/g, '$1');
            
            // Wrap lists
            html = html.replace(/(<li>.*?<\/li>)/gs, '<ul>$1</ul>');
            
            // Wrap tables - simplified approach
            html = html.replace(/(<tr>.*?<\/tr>(?:\s*<br>\s*<tr>.*?<\/tr>)*)/gs, (match) => {
                // Extract all <tr> elements from the match
                const rows = match.match(/<tr>.*?<\/tr>/gs);
                if (!rows || rows.length === 0) return match;
                
                // First row becomes header, rest become body
                const headerRow = rows[0].replace(/<td>/g, '<th>').replace(/<\/td>/g, '</th>');
                const bodyRows = rows.slice(1).join('');
                
                if (bodyRows.length > 0) {
                    return `<table><thead>${headerRow}</thead><tbody>${bodyRows}</tbody></table>`;
                } else {
                    return `<table><thead>${headerRow}</thead></table>`;
                }
            });
            
            return html;
        }

        // Set active file in sidebar
        function setActiveFile(filePath) {
            // Remove previous active states
            document.querySelectorAll('.file-item.active').forEach(item => {
                item.classList.remove('active');
            });
            
            // Find and activate current file
            const fileItems = document.querySelectorAll('.file-item');
            fileItems.forEach(item => {
                if (item.onclick.toString().includes(filePath)) {
                    item.classList.add('active');
                }
            });
        }

        // Show welcome screen
        function showWelcome() {
            const contentHeader = document.getElementById('contentHeader');
            const contentBody = document.getElementById('contentBody');
            
            contentHeader.style.display = 'none';
            contentBody.innerHTML = `
                <div class="welcome-content">
                    <h1 class="welcome-title">AI Learning Journal</h1>
                    <p class="welcome-subtitle">Comprehensive documentation and research notes on artificial intelligence, machine learning, and computer vision</p>
                    
                    <div class="welcome-stats">
                        <div class="stat-card">
                            <div class="stat-value">${allFiles.length}</div>
                            <div class="stat-label">Total Files</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${Object.keys(repositoryData).length}</div>
                            <div class="stat-label">Categories</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${readFiles.length}</div>
                            <div class="stat-label">Files Read</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${favorites.length}</div>
                            <div class="stat-label">Favorites</div>
                        </div>
                    </div>

                    <div class="quick-access">
                        <div class="quick-access-item" onclick="expandFolder('3D reconstruction')">
                            <div class="quick-access-icon">üèóÔ∏è</div>
                            <div class="quick-access-title">3D Reconstruction</div>
                            <div class="quick-access-desc">NeRF, Gaussian Splatting, and 3D vision techniques</div>
                        </div>
                        <div class="quick-access-item" onclick="expandFolder('LLM')">
                            <div class="quick-access-icon">üó£Ô∏è</div>
                            <div class="quick-access-title">Large Language Models</div>
                            <div class="quick-access-desc">GPT, LLaMA, and language model research</div>
                        </div>
                        <div class="quick-access-item" onclick="expandFolder('Diffusion_models_GAN')">
                            <div class="quick-access-icon">üé®</div>
                            <div class="quick-access-title">Generative Models</div>
                            <div class="quick-access-desc">Diffusion models, GANs, and image generation</div>
                        </div>
                        <div class="quick-access-item" onclick="expandFolder('Transformers&beyond')">
                            <div class="quick-access-icon">üîÄ</div>
                            <div class="quick-access-title">Transformers & Beyond</div>
                            <div class="quick-access-desc">Attention mechanisms and advanced architectures</div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove active file states
            document.querySelectorAll('.file-item.active').forEach(item => {
                item.classList.remove('active');
            });
            
            currentFile = null;
        }

        // Search functionality
        let searchTimeout;
        function handleSearch(query) {
            clearTimeout(searchTimeout);
            
            if (query.length < 2) {
                hideSearchResults();
                return;
            }
            
            searchTimeout = setTimeout(() => {
                performSearch(query);
            }, 300);
        }

        function performSearch(query) {
            const results = allFiles.filter(file => 
                file.displayName.toLowerCase().includes(query.toLowerCase()) ||
                file.categoryDisplayName.toLowerCase().includes(query.toLowerCase())
            ).slice(0, 10);
            
            displaySearchResults(results, query);
        }

        function displaySearchResults(results, query) {
            const searchResults = document.getElementById('searchResults');
            
            if (results.length === 0) {
                searchResults.innerHTML = '<div class="search-result-item">No results found</div>';
            } else {
                searchResults.innerHTML = results.map(file => `
                    <div class="search-result-item" onclick="selectSearchResult('${file.path}', '${file.category}')">
                        <div class="search-result-title">${highlightQuery(file.displayName, query)}</div>
                        <div class="search-result-path">${file.categoryDisplayName}</div>
                        <div class="search-result-snippet">${file.type === 'markdown' ? 'Markdown' : 'PDF'} ‚Ä¢ ${formatFileSize(file.size || 0)}</div>
                    </div>
                `).join('');
            }
            
            searchResults.style.display = 'block';
        }

        function highlightQuery(text, query) {
            const regex = new RegExp(`(${escapeRegex(query)})`, 'gi');
            return text.replace(regex, '<span class="search-highlight">$1</span>');
        }

        function escapeRegex(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        function selectSearchResult(filePath, categoryName) {
            const file = allFiles.find(f => f.path === filePath);
            if (file) {
                loadFile(file, categoryName);
                hideSearchResults();
                document.querySelector('.search-input').value = '';
            }
        }

        function showSearchResults() {
            const query = document.querySelector('.search-input').value;
            if (query.length >= 2) {
                performSearch(query);
            }
        }

        function hideSearchResults() {
            setTimeout(() => {
                document.getElementById('searchResults').style.display = 'none';
            }, 200);
        }

        // Favorites management
        function toggleFavorite(filePath) {
            const index = favorites.indexOf(filePath);
            if (index === -1) {
                favorites.push(filePath);
            } else {
                favorites.splice(index, 1);
            }
            
            localStorage.setItem('ai-journal-favorites', JSON.stringify(favorites));
            updateFavoriteIcons();
            renderFavoriteFiles();
            updateStats();
        }

        function updateFavoriteIcons() {
            document.querySelectorAll('.favorite-icon').forEach(icon => {
                const filePath = icon.getAttribute('onclick').match(/'([^']+)'/)[1];
                icon.classList.toggle('active', favorites.includes(filePath));
            });
        }

        function renderFavoriteFiles() {
            const favoriteFiles = document.getElementById('favoriteFiles');
            const favoriteFilesList = allFiles.filter(file => favorites.includes(file.path));
            
            if (favoriteFilesList.length === 0) {
                favoriteFiles.innerHTML = '<div style="color: var(--text-secondary); font-size: 14px; padding: 8px;">No favorites yet</div>';
            } else {
                favoriteFiles.innerHTML = favoriteFilesList.map(file => `
                    <div class="file-item" onclick="loadFile(${JSON.stringify(file).replace(/"/g, '&quot;')}, '${file.category}')">
                        <span class="file-icon">${file.type === 'markdown' ? 'üìÑ' : 'üìã'}</span>
                        <span class="file-name">${file.displayName}</span>
                    </div>
                `).join('');
            }
        }

        // Recent files management
        function addToRecentFiles(file, categoryName) {
            const fileWithCategory = { ...file, category: categoryName };
            const existingIndex = recentFiles.findIndex(f => f.path === file.path);
            
            if (existingIndex !== -1) {
                recentFiles.splice(existingIndex, 1);
            }
            
            recentFiles.unshift(fileWithCategory);
            recentFiles = recentFiles.slice(0, 10); // Keep only 10 recent files
            
            localStorage.setItem('ai-journal-recent', JSON.stringify(recentFiles));
            renderRecentFiles();
        }

        function renderRecentFiles() {
            const recentFilesElement = document.getElementById('recentFiles');
            
            if (recentFiles.length === 0) {
                recentFilesElement.innerHTML = '<div style="color: var(--text-secondary); font-size: 14px; padding: 8px;">No recent files</div>';
            } else {
                recentFilesElement.innerHTML = recentFiles.map(file => `
                    <div class="file-item" onclick="loadFile(${JSON.stringify(file).replace(/"/g, '&quot;')}, '${file.category}')">
                        <span class="file-icon">${file.type === 'markdown' ? 'üìÑ' : 'üìã'}</span>
                        <span class="file-name">${file.displayName}</span>
                    </div>
                `).join('');
            }
        }

        // Reading progress
        function markAsRead(filePath) {
            if (!readFiles.includes(filePath)) {
                readFiles.push(filePath);
                localStorage.setItem('ai-journal-read', JSON.stringify(readFiles));
                updateStats();
            }
        }

        // Update statistics
        function updateStats() {
            document.getElementById('totalFiles').textContent = allFiles.length;
            document.getElementById('totalCategories').textContent = Object.keys(repositoryData).length;
            document.getElementById('readFiles').textContent = readFiles.length;
            document.getElementById('favoriteCount').textContent = favorites.length;
        }

        // Theme management
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            document.documentElement.setAttribute('data-theme', newTheme);
            document.getElementById('themeIcon').textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            
            localStorage.setItem('ai-journal-theme', newTheme);
        }

        // Mobile sidebar toggle
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            
            sidebar.classList.toggle('open');
            mainContent.classList.toggle('sidebar-collapsed');
        }

        // Utility functions
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function showLoading(message = 'Loading...') {
            const contentBody = document.getElementById('contentBody');
            contentBody.classList.add('loading');
            contentBody.innerHTML = `<div class="loading">${message}</div>`;
        }

        function showError(message) {
            const contentBody = document.getElementById('contentBody');
            contentBody.innerHTML = `
                <div class="error">
                    <div class="error-title">Error</div>
                    <div>${message}</div>
                </div>
            `;
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: ${type === 'warning' ? '#f59e0b' : 'var(--primary-color)'};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: var(--shadow-lg);
                z-index: 2000;
                font-size: 14px;
                max-width: 300px;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        // Initialize theme
        function initializeTheme() {
            const savedTheme = localStorage.getItem('ai-journal-theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            document.getElementById('themeIcon').textContent = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        }

        // Handle URL hash navigation
        function handleHashNavigation() {
            const hash = window.location.hash.substring(1); // Remove #
            if (hash && hash.startsWith('file:')) {
                const filePath = decodeURIComponent(hash.substring(5)); // Remove 'file:'
                setTimeout(() => {
                    loadFileByPath(filePath);
                }, 1000); // Wait for app to initialize
            }
        }

        // Update URL when navigating to a file
        function updateUrlHash(filePath) {
            const newHash = `#file:${encodeURIComponent(filePath)}`;
            history.pushState(null, null, newHash);
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            initializeTheme();
            initializeApp();
            handleHashNavigation();
        });

        // Handle browser back/forward buttons
        window.addEventListener('popstate', () => {
            handleHashNavigation();
        });

        // Handle responsive sidebar
        window.addEventListener('resize', () => {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            
            if (window.innerWidth > 768) {
                sidebar.classList.remove('open');
                mainContent.classList.remove('sidebar-collapsed');
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                switch (e.key) {
                    case 'k':
                        e.preventDefault();
                        document.querySelector('.search-input').focus();
                        break;
                    case 'd':
                        e.preventDefault();
                        toggleTheme();
                        break;
                }
            }
            
            // PDF navigation shortcuts
            if (currentPdf && !e.ctrlKey && !e.metaKey && !e.altKey) {
                switch (e.key) {
                    case 'ArrowLeft':
                    case 'ArrowUp':
                        e.preventDefault();
                        previousPage();
                        break;
                    case 'ArrowRight':
                    case 'ArrowDown':
                    case ' ':
                        e.preventDefault();
                        nextPage();
                        break;
                    case '+':
                    case '=':
                        e.preventDefault();
                        zoomIn();
                        break;
                    case '-':
                        e.preventDefault();
                        zoomOut();
                        break;
                }
            }
            
            if (e.key === 'Escape') {
                hideSearchResults();
            }
        });
    </script>
</body>
</html>